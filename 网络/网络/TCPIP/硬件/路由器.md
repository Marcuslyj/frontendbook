这一步转发的工作原理和交换机类似，也是通过查表判断包 转发的目标。不过在具体的操作过程上，路由器和交换机是有区别的。因为 路由器是基于 IP 设计的，而交换机是基于以太网设计的。

路由器包括转发模块和端口模块两部分。路由器转发模 块和端口模块的关系，就相当于协议栈的 IP 模块和网卡之间的关系。通过更换网卡，计算机不仅可以支持以太网，也可以支持无线局域网， 路由器也是一样。此外，计算机的网卡除了以太网和无线局域网 之外很少见到支持其他通信技术的品种，而路由器的端口模块则支持除局域网之外的多种通信技术，如 ADSL、FTTH，以及各种宽带专线等，只要 端口模块安装了支持这些技术的硬件即可。



当转发包时，首先路由器端口会接收发给自己的以太网包 ，然后查询 转发目标，再由相应的端口作为发送方将以太网包发送出去。这一点和交 换机是不同的，交换机只是将进来的包转发出去而已，它自己并不会成为 发送方或者接收方。

路由器的各个端口都具有 MAC 地址和 IP 地址。



### 路由表

路由器根据“IP 地址”判断转发目标。

路由器会忽略主机号，只匹配网络号。路由表的子网掩码列只是用来在匹配目标地址时告诉路由器应该匹配多少个比特。

> 网络号什么作用？



### 收发

完成包接收操作之后，路由器就会丢弃包开头的 MAC 头部。MAC 头 部的作用就是将包送达路由器，其中的接收方 MAC 地址就是路由器端口 的 MAC 地址。因此，当包到达路由器之后，MAC 头部的任务就完成了， 于是 MAC 头部就会被丢弃。接下来，路由器会根据 MAC 头部后方的 IP 头部中的内容进行包的转 发操作。



如果在路由表中无法找到匹配的记录，路由器会丢弃这个包，并通过 ICMP 消息告知发送方。这里的处理方式和交换机不同，原因在于网络规 模的大小。交换机连接的网络最多也就是几千台设备的规模，这个规模并 不大。如果只有几千台设备，遇到不知道应该转发到哪里的包，交换机可 以将包发送到所有的端口上，虽然这个方法很简单粗暴，但不会引发什么 问题。然而，路由器工作的网络环境就是互联网，它的规模是远远大于以太网的，全世界所有的设备都连接在互联网上，而且规模还在持续扩大， 未来的互联网里到底会有多少设备，我们谁都说不准。在如此庞大的网络 中，如果将不知道应该转发到哪里的包发送到整个网络上，那就会产生大 量的网络包，造成网络拥塞。因此，路由器遇到不知道该转发到哪里的包， 就会直接丢弃。



路由器也会使用 ARP 来查询下一个转发目标的 MAC 地址。

IP 协议本身没有传输包的功能，因此包的实际传输要委托以 太网来进行。



### 包的有效期

从路由表中查找到转发目标之后，网络包就会被转交给输出端口，并 最终发送出去，但在此之前，路由器还有一些工作要完成。 第一个工作是更新 IP 头部中的 TTL（Time to Live，生存时间）字段。

TTL 字段表示包的有效期，包每经过一个路由器的 转发，这个值就会减 1，当这个值变成 0 时，就表示超过了有效期，这个 包就会被丢弃。



### 通过分片功能拆分大网络包

路由器的端口并不只有以太网一种，也可以支持其他局域网或专线通 信技术。不同的线路和局域网类型各自能传输的最大包长度也不同，因此 输出端口的最大包长度可能会小于输入端口。即便两个端口的最大包长度 相同，也可能会因为添加了一些头部数据而导致包的实际长度发生变化， ADSL、FTTH 等宽带接入技术中使用的 PPPoE 协议就属于这种情况。无 论哪种情况，一旦转发的包长度超过了输出端口能传输的最大长度，就无 法直接发送这个包了。

遇到这种情况，可以使用 IP 协议中定义的分片功能对包进行拆分，缩短每个包的长度。需要注意的是，这里说的分片和TCP 对数据进行拆分的机制是不同的。TCP 拆分数据的操作是在将数据装到包里之前进行的，换句话说，拆分好的一个数据块正好装进一个包里。从 IP 分片 的角度来看，这样一个包其实是一个未拆分的整体，也就是说，分片是对 一个完整的包再进行拆分的过程。

在分片中，TCP 头部及其后面的部分都是可分片的数据，尽管 TCP 头部不属于用户数据，但从 IP 来看也是 TCP 请求传输的数据的一部 分。数据被拆分后，每一份数据前面会加上 IP 头部，其大部分内容都和原 本的 IP 头部一模一样，但其中有部分字段需要更新，这些字段用于记录分 片相关的信息。



未拆分的完整网络包：TCP头+数据块 （对应一个TCP序列号）
## 单系统登录机制

#### http无状态协议

既然http协议无状态，那就让服务器和浏览器共同维护一个状态吧！这就是会话机制

#### 会话机制

cookie

![img](../_assets/image/dfjod)









## 多系统单点登录

#### 多系统的复杂性



![img](../_assets/image/jukiuli)

web系统由单系统发展成多系统组成的应用群，复杂性应该由系统内部承担，而不是用户。无论web系统内部多么复杂，对用户而言，都是一个统一的整体，也就是说，用户访问web系统的整个应用群与访问单个系统一样，登录/注销只要一次就够了

![img](../_assets/image/kohger)



#### cookie方式存在问题

- 跨域，应用群域名得统一（所有子系统的域名统一在一个顶级域名下）
- 应用群各系统使用的技术（至少是web服务器）要相同，不然cookie的key值（tomcat为JSESSIONID）不同，无法维持会话，共享cookie的方式是无法实现跨语言技术平台登录的，比如java、php、.net系统之间
- cookie本身不安全





#### 实现机制

![img](../_assets/image/jferhogiurheivguhf)



流程：

1. 用户访问系统1的受保护资源，系统1发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
2. sso认证中心发现用户未登录，将用户引导至登录页面
3. 用户输入用户名密码提交登录申请
4. sso认证中心校验用户信息，创建用户与sso认证中心之间的会话，称为全局会话，同时创建授权令牌
5. sso认证中心***带着令牌跳转会最初的请求地址***（系统1）
6. 系统1拿到令牌，去sso认证中心校验令牌是否有效
7. sso认证中心校验令牌，返回有效，注册系统1
8. 系统1使用该令牌创建与用户的会话，称为局部会话，返回受保护资源
9. 用户访问系统2的受保护资源
10. 系统2发现用户未登录，跳转至sso认证中心，并将自己的地址作为参数
11. sso认证中心发现用户已登录，跳转回系统2的地址，并附上令牌
12. 系统2拿到令牌，去sso认证中心校验令牌是否有效
13. sso认证中心校验令牌，返回有效，注册系统2
14. 系统2使用该令牌创建与用户的局部会话，返回受保护资源





**有的同学问我，SSO系统登录后，跳回原业务系统时，带了个参数ST，业务系统还要拿ST再次访问SSO进行验证，觉得这个步骤有点多余。他想SSO登录认证通过后，通过回调地址将用户信息返回给原业务系统，原业务系统直接设置登录状态，这样流程简单，也完成了登录，不是很好吗？**

**其实这样问题时很严重的，如果我在SSO没有登录，而是直接在浏览器中敲入回调的地址，并带上伪造的用户信息，是不是业务系统也认为登录了呢？这是很可怕的。**









# 基于 JWT 的单点登录设计

相比于 session 认证，JWT 省去了服务器存储用户信息的过程。

> #### jwt数据结构

![img](../_assets/image/D8243D7287E04D011E54B1CF0000A0B3)

- ##### JWT头

  算法信息，base64

- ##### 有效载荷

  有效载荷部分，是JWT的主体内容部分，也是一个JSON对象，包含需要传递的数据。base64

- ##### 签名哈希

  签名哈希部分是对上面两部分数据签名，通过指定的算法生成哈希，以确保数据不会被篡改。

  密钥在服务端，使用jwt头的加密算法

  

#### 问题

JWT的最大缺点是服务器不保存会话状态，所以在使用期间不可能取消令牌或更改令牌的权限。也就是说，一旦JWT签发，在有效期内将会一直有效。

为了减少盗用，JWT的有效期不宜设置太长。
可用jwt+ip增加安全性
















